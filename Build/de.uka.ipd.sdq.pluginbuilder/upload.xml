<project name="UpdateSite" default="upload">
	
	<taskdef resource="org/pluginbuilder/anttasks/pluginbuildertasks.properties" classpath="build-files/pluginbuilder-anttasks.jar" />
	
	<GetHostName />
	<property file="build_${hostname}.properties" />
	<property file="build_local.properties" />
	<property file="upload.properties" />
	
	<target name="clean_remote">
		<sshexec host="${uploadTargetHost}"
				username="${uploadUsername}"
				keyfile="/home/ccontrol/.ssh/id_rsa" 
				passphrase="" 
				trust="true" 
		command="cd ${uploadTargetDir}; 
			rm -rf *; 
			"/>
	</target>

	<target name="upload" depends="clean_remote, copy_local">
	<!-- <target name="upload" depends="clean_remote"> -->
		<scp todir="${uploadUsername}@${uploadTargetHost}:${uploadTargetDir}"
				keyfile="/home/ccontrol/.ssh/id_rsa" 
				passphrase="" 
				trust="true">
		    <fileset dir="${buildDirectory}/p2-updateSite"/>
	  	</scp>			
		<scp todir="${uploadUsername}@${uploadTargetHost}:${uploadTargetDir}"
				keyfile="/home/ccontrol/.ssh/id_rsa" 
				passphrase="" 
				trust="true">
		    <fileset dir="${buildDirectory}/results/">
			<include name="p2-repository*.zip"/>
		    </fileset>
	  	</scp>			
		<scp todir="${uploadUsername}@${uploadTargetHost}:${uploadTargetDir}"
				keyfile="/home/ccontrol/.ssh/id_rsa" 
				passphrase="" 
				trust="true">
			<fileset dir="${buildDirectory}">
				<include name="*.txt" />				
			</fileset>
	  	</scp>
		
		<!-- test results: -->
		<scp todir="${uploadUsername}@${uploadTargetHost}:${uploadTargetDir}"
				keyfile="/home/ccontrol/.ssh/id_rsa" 
				passphrase="" 
				trust="true">
		    <fileset dir="${buildDirectory}/results/testresults/html"/>
	  </scp>
		<scp todir="${uploadUsername}@${uploadTargetHost}:${uploadTargetDir}"
				keyfile="/home/ccontrol/.ssh/id_rsa" 
				passphrase="" 
				trust="true">
		    <fileset dir="${buildDirectory}/results/testresults/coverage"/>
	  	</scp>
	  	<sshexec host="${uploadTargetHost}"
				username="${uploadUsername}"
				keyfile="/home/ccontrol/.ssh/id_rsa" 
				passphrase="" 
				trust="true" 
				command="cd ${uploadTargetDir}; 
			mv test*.html testresults.html; 
			mv p2-repository*.zip p2-pository-nightly.zip;
			"/> 
	</target>

	<target name="clean_local">
		<delete dir="${copyTargetDir}" />
	</target>
	<!-- local copy of updatesite for linking into other projects eclipse -->
	<target name="copy_local" depends="clean_local">
		<copy todir="${copyTargetDir}">
			<fileset dir="${buildDirectory}/p2-updateSite" />
		</copy>
		<!-- <touch file="${copyTargetDir}/../pcm-trigger/touch"></touch> -->
	</target>
	
</project>
